
```{r splinefunc, cache=cacheon}

mytermplot <- function(mod, xlab = "Time since previous HFH (months)", ylab = "Hazard Ratio (95% CI)", yaxismy = c(0.3, 0.5, 1, 1.5, 2, 2.5)) {
  cexmy <- 1.2

  zz <- termplot(mod, se = TRUE, plot = FALSE, terms = 1)
  lci <- zz$chfdc_dt3num$y - 1.96 * zz$chfdc_dt3num$se
  uci <- zz$chfdc_dt3num$y + 1.96 * zz$chfdc_dt3num$se

  # c(bottom, left, top, right)
  par(mar = c(5, 4, 2, 2) + 0.1)

  plot(zz$chfdc_dt3num$x, zz$chfdc_dt3num$y,
    type = "n", axes = F,
    xaxs = "i", yaxs = "i", xlim = c(0, 366), ylim = log(c(min(yaxismy), max(yaxismy))),
    xlab = xlab, ylab = ylab, cex.lab = cexmy
  )

  polygon(
    x = c(rev(zz$chfdc_dt3num$x), zz$chfdc_dt3num$x),
    y = c(rev(uci), lci),
    col = global_cols[8],
    border = NA
  )

  axis(1, seq(0, 12, 1) * 30.5, seq(0, 12, 1), cex.axis = cexmy)
  axis(2, log(yaxismy), yaxismy, las = 2, cex.axis = cexmy)

  lines(zz$chfdc_dt3num$x, zz$chfdc_dt3num$y, lwd = 3, col = global_cols[3])

  abline(h = 0, col = 1, lty = 3, lwd = 2)

  rug(tcdataimphf$chfdc_dt3num)

  invisible(zz)
}

splinefunc <- function(time = NULL, event) {
  if (!is.null(time)) {
    mod <- coxph(formula(paste0(
      "Surv(", time, ",", event, " == 'Yes') ~ ns(chfdc_dt3num, df = 5) + ",
      paste(modvarscox, collapse = " + ")
    )),
    data = tcdataimphf
    )
  } else {
    mod <- coxph(formula(paste0(
      "Surv(timestart, timestop, ", event, " == 'Yes') ~ ns(chfdc_dt3num, df = 5) + ",
      paste(modvarscox, collapse = " + "),
      " + cluster(ID) + strata(eventno)"
    )),
    data = tcdataimprechf
    )
  }
  mytermplot(mod)
}
```

```{r scvdrephfh, fig.cap="Spline CVD/recurrent HFH", cache=cacheon, dependson="splinefunc", fig.width=8, fig.height=7}
splinefunc(
  event = "out_cvdhfh"
)
```

```{r scvd, fig.cap="Spline CVD", cache=cacheon, dependson="splinefunc", fig.width=8, fig.height=7}
splinefunc(
  time = "outtime_cvd",
  event = "out_cvd"
)
```

```{r srephfh, fig.cap="Spline recurrent HFH", cache=cacheon, dependson="splinefunc", fig.width=8, fig.height=7}
splinefunc(
  event = "out_hfh"
)
```

```{r scvdhfh1, fig.cap="Spline CVD/first HFH", cache=cacheon, dependson="splinefunc", fig.width=8, fig.height=7}
splinefunc(
  time = "outtime_hfh",
  event = "out_cvdhfh"
)
```
  
```{r shfh1, fig.cap="Spline first HFH", cache=cacheon, dependson="splinefunc", fig.width=8, fig.height=7}
splinefunc(
  time = "outtime_hfh",
  event = "out_hfh"
)
```
